<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Nepaltr Pro | Trading</title>
    <script src="https://www.gstatic.com/firebasejs/9.1.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.1/firebase-database-compat.js"></script>
    <style>
        :root { --bg: #0b0e11; --panel: #181a20; --accent: #fcd535; --border: #2b3139; --up: #0ecb81; --down: #f6465d; }
        body { margin: 0; background: var(--bg); color: white; font-family: sans-serif; overflow: hidden; }
        header { display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; background: var(--panel); border-bottom: 1px solid var(--border); }
        
        /* Modals */
        .modal-wrap { position: fixed; inset: 0; background: rgba(0,0,0,0.95); display: none; justify-content: center; align-items: center; z-index: 9999; padding: 20px; }
        .modal-box { background: var(--panel); width: 100%; max-width: 360px; padding: 25px; border-radius: 16px; border: 1px solid var(--border); position: relative; }
        .input-f { width: 100%; padding: 12px; margin-bottom: 12px; background: #000; border: 1px solid var(--border); color: white; border-radius: 8px; box-sizing: border-box; }
        
        /* Buttons */
        .btn-yellow { width: 100%; padding: 14px; background: var(--accent); border: none; border-radius: 8px; font-weight: bold; cursor: pointer; color: #000; margin-top: 5px; }
        .google-btn { width: 100%; padding: 12px; background: white; color: #000; border: none; border-radius: 8px; font-weight: bold; display: flex; align-items: center; justify-content: center; gap: 10px; cursor: pointer; margin-bottom: 20px; }
        .google-btn img { width: 18px; }

        /* Trade Dock */
        .dock { position: fixed; bottom: 0; width: 100%; background: var(--panel); padding: 15px; border-top: 1px solid var(--border); display: flex; flex-direction: column; gap: 10px; }
        .dock-row { display: flex; gap: 10px; }
        .t-btn { flex: 1; height: 50px; border: none; border-radius: 8px; font-weight: bold; color: white; cursor: pointer; font-size: 16px; }
        
        #result-anim { position: fixed; inset: 0; display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 10000; background: rgba(0,0,0,0.8); font-size: 30px; font-weight: bold; text-align: center; }
    </style>
</head>
<body>

<div id="result-anim"></div>

<header>
    <div style="font-weight:bold; font-size: 18px;">Nepal<span style="color:var(--accent)">tr</span></div>
    <div style="display:flex; gap:15px; align-items:center;">
        <div id="top-bal" style="color:var(--accent); font-weight:bold;">NPR 0.00</div>
        <div onclick="openMod('login')" style="cursor:pointer">ðŸ‘¤</div>
    </header>

<div id="tv_chart" style="height: calc(100vh - 180px);"></div>

<div class="dock">
    <div class="dock-row">
        <select id="t-duration" class="input-f" style="margin:0; flex:1;">
            <option value="30">30 Seconds</option>
            <option value="60">1 Minute</option>
            <option value="300">5 Minutes</option>
            <option value="3600">1 Hour</option>
            <option value="43200">12 Hours</option>
        </select>
        <input type="number" id="t-amount" class="input-f" style="margin:0; flex:1;" value="300" min="300" max="10000" placeholder="Amount">
    </div>
    <div class="dock-row">
        <button class="t-btn" style="background:var(--up)" onclick="startTrade('UP')">CALL</button>
        <button class="t-btn" style="background:var(--down)" onclick="startTrade('DOWN')">PUT</button>
    </div>
</div>

<div id="modal-wrap" class="modal-wrap">
    <div class="modal-box" id="modal-content"></div>
</div>

<script src="https://s3.tradingview.com/tv.js"></script>
<script>
    const firebaseConfig = {
        apiKey: "AIzaSyCNt94Sr7tvtY6bLQcYCYeRb_cTcah7fE4",
        databaseURL: "https://earning-website-644a7-default-rtdb.asia-southeast1.firebasedatabase.app"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database(), auth = firebase.auth();

    let currentUser = null, balance = 0, tradeCount = 0;

    auth.onAuthStateChanged(user => {
        currentUser = user;
        if(user) {
            db.ref('users/' + user.uid).on('value', snap => {
                const data = snap.val() || {};
                balance = data.balance || 0;
                tradeCount = data.tradeCount || 0;
                document.getElementById('top-bal').innerText = "NPR " + balance.toFixed(2);
            });
        }
    });

    function openMod(type) {
        const box = document.getElementById('modal-content');
        document.getElementById('modal-wrap').style.display = 'flex';
        box.innerHTML = `<span onclick="document.getElementById('modal-wrap').style.display='none'" style="position:absolute; right:15px; top:10px; cursor:pointer;">âœ•</span>`;

        if(type === 'login') {
            box.innerHTML += `<h3>Login</h3>
                <button class="google-btn" onclick="googleSignIn()">
                    <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/action/google.svg"> Continue with Google
                </button>
                <input id="em" placeholder="Email" class="input-f">
                <input id="ps" type="password" placeholder="Password" class="input-f">
                <button class="btn-yellow" onclick="emailLogin()">Login</button>
                <p style="font-size:12px; text-align:center; margin-top:15px;">Don't have an account? <span onclick="openMod('register')" style="color:var(--accent); cursor:pointer;">Register</span></p>`;
        } else if(type === 'register') {
            box.innerHTML += `<h3>Create Account</h3>
                <input id="reg-em" placeholder="Email" class="input-f">
                <input id="reg-ps" type="password" placeholder="Password" class="input-f">
                <button class="btn-yellow" onclick="emailRegister()">Register</button>
                <p style="font-size:12px; text-align:center; margin-top:15px;">Already have an account? <span onclick="openMod('login')" style="color:var(--accent); cursor:pointer;">Login</span></p>`;
        }
    }

    // --- WORKING AUTH FUNCTIONS ---
    async function googleSignIn() {
        try {
            const provider = new firebase.auth.GoogleAuthProvider();
            const result = await auth.signInWithPopup(provider);
            await checkUserRecord(result.user);
            document.getElementById('modal-wrap').style.display = 'none';
        } catch (e) { alert("Google Sign-in failed: " + e.message); }
    }

    async function emailLogin() {
        const e = document.getElementById('em').value, p = document.getElementById('ps').value;
        try {
            await auth.signInWithEmailAndPassword(e, p);
            document.getElementById('modal-wrap').style.display = 'none';
        } catch (err) { alert(err.message); }
    }

    async function emailRegister() {
        const e = document.getElementById('reg-em').value, p = document.getElementById('reg-ps').value;
        try {
            const result = await auth.createUserWithEmailAndPassword(e, p);
            await checkUserRecord(result.user);
            alert("Account Created!");
            document.getElementById('modal-wrap').style.display = 'none';
        } catch (err) { alert(err.message); }
    }

    async function checkUserRecord(user) {
        const snap = await db.ref('users/' + user.uid).get();
        if(!snap.exists()) {
            await db.ref('users/' + user.uid).set({ balance: 0, tradeCount: 0, email: user.email });
        }
    }

    // --- TRADE LOGIC ---
    function startTrade(dir) {
        const amt = parseFloat(document.getElementById('t-amount').value);
        const dur = parseInt(document.getElementById('t-duration').value);

        if(!currentUser) return openMod('login');
        if(amt < 300 || amt > 10000) return alert("Investment must be between 300 and 10,000");
        if(balance < amt) return alert("Insufficient Balance!");

        db.ref('users/' + currentUser.uid + '/balance').set(balance - amt);
        
        const anim = document.getElementById('result-anim');
        anim.style.display = 'flex';
        anim.innerHTML = `<span style="color:var(--accent)">Waiting for Result...</span><br><span id="timer-display" style="font-size:20px;"></span>`;

        let timeLeft = (dur > 30) ? 5 : dur; // Visual countdown cap for long trades
        const countdown = setInterval(() => {
            document.getElementById('timer-display').innerText = timeLeft + "s";
            timeLeft--;
            if(timeLeft < 0) {
                clearInterval(countdown);
                finishTrade(amt);
            }
        }, 1000);
    }

    function finishTrade(amt) {
        tradeCount++;
        const win = (tradeCount % 10 === 3 || tradeCount % 10 === 7);
        const anim = document.getElementById('result-anim');

        if(win) {
            const profit = amt * 1.85;
            db.ref('users/' + currentUser.uid + '/balance').set(balance + profit);
            anim.innerHTML = `<span style="color:var(--up)">WIN<br>+NPR ${profit.toFixed(0)}</span>`;
        } else {
            anim.innerHTML = `<span style="color:var(--down)">LOSS<br>-NPR ${amt}</span>`;
        }
        db.ref('users/' + currentUser.uid + '/tradeCount').set(tradeCount);
        setTimeout(() => anim.style.display = 'none', 3000);
    }

    new TradingView.widget({"autosize": true, "symbol": "BINANCE:BTCUSDT", "theme": "dark", "container_id": "tv_chart"});
</script>
</body>
</html>
